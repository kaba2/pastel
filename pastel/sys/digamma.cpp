#include "pastel/sys/digamma.h"
#include "pastel/sys/ensure.h"
#include "pastel/sys/math_functions.h"

namespace Pastel
{

	namespace
	{

		// The digamma function evaluated at integer parameters
		// from 0 to 256. Computed with Maple, accurate to 16 decimals.

		real64 digamma_[257] = 
		{
			0,
			-.5772156649015329, .4227843350984671, .9227843350984671, 1.256117668431800, 
			1.506117668431800, 1.706117668431800, 1.872784335098467, 2.015641477955610, 
			2.140641477955610, 2.251752589066721, 2.351752589066721, 2.442661679975812, 
			2.525995013309145, 2.602918090232222, 2.674346661660794, 2.741013328327460, 
			2.803513328327460, 2.862336857739225, 2.917892413294780, 2.970523992242149, 
			3.020523992242149, 3.068143039861197, 3.113597585315742, 3.157075846185307, 
			3.198742512851974, 3.238742512851974, 3.277204051313512, 3.314241088350549, 
			3.349955374064835, 3.384438132685525, 3.417771466018858, 3.450029530534987, 
			3.481279530534987, 3.511582560838017, 3.540994325543900, 3.569565754115328, 
			3.597343531893106, 3.624370558920133, 3.650686348393817, 3.676327374034843, 
			3.701327374034843, 3.725717617937282, 3.749527141746806, 3.772782955700294, 
			3.795510228427567, 3.817732450649789, 3.839471581084572, 3.860748176829253, 
			3.881581510162586, 3.901989673427892, 3.921989673427892, 3.941597516565147, 
			3.960828285795916, 3.979696210324218, 3.998214728842737, 4.016396547024555, 
			4.034253689881698, 4.051797549530821, 4.069038928841165, 4.085988081383538, 
			4.102654748050205, 4.119048190673156, 4.135177222931220, 4.151050238804236, 
			4.166675238804236, 4.182059854188852, 4.197211369340367, 4.212136742474695, 
			4.226842624827636, 4.241335378450825, 4.255621092736539, 4.269705599778792, 
			4.283594488667681, 4.297293118804668, 4.310806632318181, 4.324139965651514, 
			4.337297860388357, 4.350284873375370, 4.363105386195882, 4.375763614043984, 
			4.388263614043984, 4.400609293056329, 4.412804415007549, 4.424852607778633, 
			4.436757369683395, 4.448522075565748, 4.460149982542492, 4.471644235416055, 
			4.483007871779692, 4.494243826835872, 4.505354937946983, 4.516343948935994, 
			4.527213514153385, 4.537966202325428, 4.548604500197768, 4.559130815987242, 
			4.569547482653909, 4.579856761004424, 4.590060842637077, 4.600161852738087, 
			4.610161852738087, 4.620062842837097, 4.629866764405725, 4.639575502269802, 
			4.649190886885187, 4.658714696408997, 4.668148658673148, 4.677494453065671, 
			4.686753712324930, 4.695928024251536, 4.705018933342445, 4.714027942351454, 
			4.722956513780025, 4.731806071302149, 4.740578001126710, 4.749273653300624, 
			4.757894342955796, 4.766441351502804, 4.774915927773991, 4.783319289118529, 
			4.791652622451862, 4.799917085261779, 4.808113806573255, 4.816243887874068, 
			4.824308404003100, 4.832308404003100, 4.840244911939608, 4.848118927687640, 
			4.855931427687640, 4.863683365672136, 4.871375673364443, 4.879009261150703, 
			4.886585018726460, 4.894103815718942, 4.901566502286106, 4.908973909693513, 
			4.916326850869984, 4.923626120942977, 4.930872497754571, 4.938066742358887, 
			4.945209599501744, 4.952301798083305, 4.959344051604431, 4.966337058597438, 
			4.973281503041883, 4.980178054766021, 4.987027369834514, 4.993830090922949, 
			5.000586847679706, 5.007298257075679, 5.013964923742346, 5.020587440298637, 
			5.027166387667058, 5.033702335379477, 5.040195841872983, 5.046647454776209, 
			5.053057711186465, 5.059427137938058, 5.065756251862108, 5.072045560038209, 
			5.078295560038209, 5.084506740162433, 5.090679579668605, 5.096814548993759, 
			5.102912109969369, 5.108972716029975, 5.114996812415517, 5.120984836367613, 
			5.126937217319994, 5.132854377083307, 5.138736730024484, 5.144584683240858, 
			5.150398636729230, 5.156178983550039, 5.161926109986821, 5.167640395701107, 
			5.173322213882925, 5.178971931397049, 5.184589908925139, 5.190176501103910, 
			5.195732056659465, 5.201256918537918, 5.206751424032424, 5.212215904906741, 
			5.217650687515437, 5.223056092920842, 5.228432437006863, 5.233780030589751, 
			5.239099179525921, 5.244390184816927, 5.249653342711664, 5.254888944805904, 
			5.260097278139238, 5.265278625289497, 5.270433264464755, 5.275561469592960, 
			5.280663510409286, 5.285739652541266, 5.290790157591771, 5.295815283219912,
			5.300815283219912, 5.305790407598021, 5.310740902647526, 5.315667011021910,
			5.320568971806224, 5.325447020586712, 5.330301389518751, 5.335132307393147, 
			5.339939999700839, 5.344724688696054, 5.349486593457959, 5.354225929950850, 
			5.358942911082926, 5.363637746763677, 5.368310643959938, 5.372961806750636, 
			5.377591436380266, 5.382199731311141, 5.386786887274444, 5.391353097320106, 
			5.395898551865561, 5.400423438743389, 5.404927943247893, 5.409412248180629, 
			5.413876533894914, 5.418320978339359, 5.422745757100421, 5.427151043444033, 
			5.431537008356314, 5.435903820583388, 5.440251646670345, 5.444580650999349, 
			5.448890995826935, 5.453182841320497, 5.457456345594002, 5.461711664742938, 
			5.465948952878531, 5.470168362161231, 5.474370042833500, 5.478554143251910, 
			5.482720809918577, 5.486870187511938, 5.491002418916897, 5.495117645254345, 
			5.499216005910083, 5.503297638563144, 5.507362679213551, 5.511411262209502, 
			5.515443520274018, 5.519459584531046, 5.523459584531046, 5.527443648276066, 
			5.531411902244320, 5.535364471414281, 5.539301479288297, 5.543223047915748
		};

	}

	PASTELSYS real64 digammaReal64(integer n)
	{
		// It holds that for integer parameters,
		// digamma(n) = H(n - 1) - y
		// where y is Euler-Mascheroni constant,
		// and H(n) is the n:th harmonic number:
		// H(n) = 1 / 1 + 1 / 2 + ... + 1 / n.
		//
		// From Wikipedia:
		// The harmonic number can be approximated
		// with:
		// H(n) = y + ln(n) + (1/2) n^-1 - (1/12) n^-2 + 
		//       (1/120) n^-4 + O(n^-6)
		//
		// Thus the digamma function can be approximated
		// with (note that the y is cancelled away):
		// digamma(n) = ln(n - 1) + (1/2) (n - 1)^-1 - (1/12) (n - 1)^-2 + 
		//       (1/120) (n - 1)^-4 + O(n^-6)
		//
		// Comparing the practical error of this formula with Maple,
		// It seems that that there is non-negligible
		// error in the beginning of this sequence.
		// Therefore we have computed the harmonic numbers
		// from 1 to 256 accurate to 16 decimals.
		// After this we use the approximation,
		// which is very accurate after this initial range.

		PENSURE_OP(n, >, 0);

		if (n < 257)
		{
			return digamma_[n];
		}
		
		real64 nInv = (real)1 / (n - 1);
		const real64 nInv2 = square(nInv);

		// Add in increasing order for accuracy.


		real64 result = ((real)1 / 120) * square(nInv2);
		result -= ((real)1 / 12) * nInv2;
		result += ((real)1 / 2) * nInv;
		result += std::log((real)(n - 1));

		return result;
	}

}