#include "pastel/math/mathcommon.h"
#include "pastel/sys/syscommon.h"

namespace Pastel
{

	namespace
	{

		// The harmonic numbers from H_0 to H_256.
		// H_0 = 0
		// H_n = 1/1 + 1/2 + 1/3 + ... + 1/n
		// Computed with Maple, accurate to 16 decimals.

		real harmonicNumber_[257] = 
		{
			0,
			1.000000000000000, 1.500000000000000, 1.833333333333333, 2.083333333333333, 
			2.283333333333333, 2.450000000000000, 2.592857142857143, 2.717857142857143, 
			2.828968253968254, 2.928968253968254, 3.019877344877345, 3.103210678210678, 
			3.180133755133755, 3.251562326562327, 3.318228993228993, 3.380728993228993, 
			3.439552522640758, 3.495108078196313, 3.547739657143682, 3.597739657143682, 
			3.645358704762730, 3.690813250217275, 3.734291511086840, 3.775958177753507, 
			3.815958177753507, 3.854419716215045, 3.891456753252082, 3.927171038966368, 
			3.961653797587058, 3.994987130920391, 4.027245195436520, 4.058495195436520, 
			4.088798225739550, 4.118209990445433, 4.146781419016861, 4.174559196794639, 
			4.201586223821666, 4.227902013295350, 4.253543038936376, 4.278543038936376, 
			4.302933282838815, 4.326742806648339, 4.349998620601827, 4.372725893329100, 
			4.394948115551322, 4.416687245986105, 4.437963841730786, 4.458797175064119, 
			4.479205338329425, 4.499205338329425, 4.518813181466680, 4.538043950697449, 
			4.556911875225751, 4.575430393744270, 4.593612211926088, 4.611469354783231, 
			4.629013214432353, 4.646254593742698, 4.663203746285071, 4.679870412951738, 
			4.696263855574689, 4.712392887832753, 4.728265903705769, 4.743890903705769, 
			4.759275519090384, 4.774427034241900, 4.789352407376228, 4.804058289729169, 
			4.818551043352358, 4.832836757638072, 4.846921264680325, 4.860810153569214, 
			4.874508783706200, 4.888022297219714, 4.901355630553047, 4.914513525289889, 
			4.927500538276902, 4.940321051097415, 4.952979278945517, 4.965479278945517, 
			4.977824957957862, 4.990020079909082, 5.002068272680166, 5.013973034584928, 
			5.025737740467281, 5.037365647444025, 5.048859900317588, 5.060223536681225, 
			5.071459491737404, 5.082570602848516, 5.093559613837527, 5.104429179054918, 
			5.115181867226961, 5.125820165099301, 5.136346480888775, 5.146763147555442, 
			5.157072425905957, 5.167276507538610, 5.177377517639620, 5.187377517639620, 
			5.197278507738630, 5.207082429307258, 5.216791167171335, 5.226406551786720, 
			5.235930361310529, 5.245364323574680, 5.254710117967204, 5.263969377226463, 
			5.273143689153068, 5.282234598243978, 5.291243607252987, 5.300172178681558, 
			5.309021736203682, 5.317793666028243, 5.326489318202156, 5.335110007857329, 
			5.343657016404337, 5.352131592675524, 5.360534954020062, 5.368868287353395, 
			5.377132750163312, 5.385329471474788, 5.393459552775601, 5.401524068904633, 
			5.409524068904633, 5.417460576841141, 5.425334592589172, 5.433147092589172, 
			5.440899030573668, 5.448591338265976, 5.456224926052236, 5.463800683627993, 
			5.471319480620475, 5.478782167187639, 5.486189574595046, 5.493542515771517, 
			5.500841785844509, 5.508088162656104, 5.515282407260420, 5.522425264403277, 
			5.529517462984838, 5.536559716505964, 5.543552723498971, 5.550497167943416, 
			5.557393719667554, 5.564243034736047, 5.571045755824482, 5.577802512581239, 
			5.584513921977212, 5.591180588643879, 5.597803105200170, 5.604382052568591, 
			5.610918000281010, 5.617411506774516, 5.623863119677742, 5.630273376087998, 
			5.636642802839591, 5.642971916763641, 5.649261224939742, 5.655511224939742, 
			5.661722405063965, 5.667895244570138, 5.674030213895292, 5.680127774870901, 
			5.686188380931508, 5.692212477317050, 5.698200501269145, 5.704152882221526, 
			5.710070041984840, 5.715952394926017, 5.721800348142391, 5.727614301630763, 
			5.733394648451572, 5.739141774888354, 5.744856060602639, 5.750537878784458, 
			5.756187596298582, 5.761805573826672, 5.767392166005443, 5.772947721560998, 
			5.778472583439451, 5.783967088933957, 5.789431569808274, 5.794866352416969, 
			5.800271757822375, 5.805648101908396, 5.810995695491284, 5.816314844427454, 
			5.821605849718460, 5.826869007613196, 5.832104609707437, 5.837312943040771, 
			5.842494290191030, 5.847648929366287, 5.852777134494492, 5.857879175310819, 
			5.862955317442799, 5.868005822493304, 5.873030948121444, 5.878030948121444, 
			5.883006072499554, 5.887956567549059, 5.892882675923443, 5.897784636707757, 
			5.902662685488245, 5.907517054420283, 5.912347972294680, 5.917155664602372, 
			5.921940353597587, 5.926702258359492, 5.931441594852383, 5.936158575984458, 
			5.940853411665210, 5.945526308861471, 5.950177471652169, 5.954807101281799, 
			5.959415396212674, 5.964002552175977, 5.968568762221639, 5.973114216767094, 
			5.977639103644922, 5.982143608149426, 5.986627913082162, 5.991092198796447,
			5.995536643240892, 5.999961422001954, 6.004366708345566, 6.008752673257847, 
			6.013119485484921, 6.017467311571877, 6.021796315900882, 6.026106660728468, 
			6.030398506222030, 6.034672010495535, 6.038927329644471, 6.043164617780064, 
			6.047384027062764, 6.051585707735033, 6.055769808153443, 6.059936474820110, 
			6.064085852413471, 6.068218083818430, 6.072333310155878, 6.076431670811616, 
			6.080513303464677, 6.084578344115084, 6.088626927111035, 6.092659185175551, 
			6.096675249432579, 6.100675249432579, 6.104659313177599, 6.108627567145853, 
			6.112580136315814, 6.116517144189829, 6.120438712817280, 6.124344962817280
		};

	}

	PASTELMATH real harmonicNumber(integer n)
	{
		// FIX: Implement in terms of digamma!

		// The n:th harmonic number H_n is given by:
		// H_0 = 0
		// H_n = 1/1 + 1/2 + 1/3 + ... + 1/n
		//
		// From Wikipedia:
		// The harmonic number can be approximated
		// with:
		// H_n = y + ln(n) + (1/2) n^-1 - (1/12) n^-2 + 
		//       (1/120) n^-4 + O(n^-6)
		// where y is Euler-Mascheroni constant.
		// 
		// Comparing the practical error of this formula with Maple,
		// It seems that that there is non-negligible
		// error in the beginning of this sequence, beginning with:
		// -0.0022156649015329, -0.0000503454614782, -0.000004908302153, ...
		// Therefore we have computed the harmonic numbers
		// from 1 to 256 accurate to 16 decimals.
		// After this we use the approximation,
		// which is very accurate after this initial range.

		ENSURE1(n >= 0, n);

		if (n < 257)
		{
			return harmonicNumber_[n];
		}
		
		const real nInv = (real)1 / n;
		const real nInv2 = square(nInv);

		// Add in increasing order for accuracy.

		real result = ((real)1 / 120) * square(nInv2);
		result -= ((real)1 / 12) * nInv2;
		result += ((real)1 / 2) * nInv;
		result += constantEulerMascheroni<real>();
		result += std::log((real)n);

		return result;
	}

	namespace
	{

		// lnFactorial[n] = ln(n!)
		// where ln is the natural logarithm.
		// Computed with Maple to 16 digits.
		
		real lnFactorial_[257] = {
			0,
			0., .6931471805599453, 1.791759469228055, 3.178053830347946, 
			4.787491742782046, 6.579251212010101, 8.525161361065414, 10.60460290274525, 
			12.80182748008147, 15.10441257307552, 17.50230784587389, 19.98721449566189, 
			22.55216385312342, 25.19122118273868, 27.89927138384089, 30.67186010608067, 
			33.50507345013689, 36.39544520803305, 39.33988418719949, 42.33561646075348, 
			45.38013889847691, 48.47118135183522, 51.60667556776437, 54.78472939811232, 
			58.00360522298052, 61.26170176100200, 64.55753862700633, 67.88974313718154, 
			71.25703896716801, 74.65823634883016, 78.09222355331531, 81.55795945611504, 
			85.05446701758152, 88.58082754219768, 92.13617560368709, 95.71969454214320, 
			99.33061245478743, 102.9681986145138, 106.6317602606435, 110.3206397147574, 
			114.0342117814617, 117.7718813997451, 121.5330815154386, 125.3172711493569, 
			129.1239336391272, 132.9525750356163, 136.8027226373264, 140.6739236482343, 
			144.5657439463449, 148.4777669517730, 152.4095925844974, 156.3608363030788, 
			160.3311282166309, 164.3201122631952, 168.3274454484277, 172.3527971391628, 
			176.3958484069974, 180.4562914175438, 184.5338288614495, 188.6281734236716, 
			192.7390472878449, 196.8661816728900, 201.0093163992815, 205.1681994826412, 
			209.3425867525368, 213.5322414945633, 217.7369341139542, 221.9564418191303, 
			226.1905483237276, 230.4390435657770, 234.7017234428183, 238.9783895618343, 
			243.2688490029827, 247.5729140961869, 251.8904022097232, 256.2211355500095, 
			260.5649409718632, 264.9216497985528, 269.2910976510198, 273.6731242856937, 
			278.0675734403661, 282.4742926876304, 286.8931332954270, 291.3239500942703, 
			295.7666013507606, 300.2209486470141, 304.6868567656687, 309.1641935801469, 
			313.6528299498791, 318.1526396202093, 322.6634991267262, 327.1852877037752, 
			331.7178871969285, 336.2611819791985, 340.8150588707990, 345.3794070622669, 
			349.9541180407702, 354.5390855194408, 359.1342053695754, 363.7393755555635, 
			368.3544960724047, 372.9794688856890, 377.6141978739187, 382.2585887730600, 
			386.9125491232176, 391.5759882173296, 396.2488170517915, 400.9309482789157, 
			405.6222961611449, 410.3227765269373, 415.0323067282496, 419.7508055995447, 
			424.4781934182571, 429.2143918666516, 433.9593239950148, 438.7129141861212, 
			443.4750881209189, 448.2457727453846, 453.0248962384961, 457.8123879812782, 
			462.6081785268749, 467.4121995716082, 472.2243839269806, 477.0446654925856, 
			481.8729792298879, 486.7092611368394, 491.5534482232980, 496.4054784872176, 
			501.2652908915793, 506.1328253420349, 511.0080226652360, 515.8908245878224, 
			520.7811737160442, 525.6790135159951, 530.5842882944335, 535.4969431801695, 
			540.4169241059977, 545.3441777911549, 550.2786517242856, 555.2202941468949, 
			560.1690540372730, 565.1248810948743, 570.0877257251342, 575.0575390247102, 
			580.0342727671308, 585.0178793888391, 590.0083119756179, 595.0055242493820, 
			600.0094705553274, 605.0201058494237, 610.0373856862386, 615.0612662070849, 
			620.0917041284773, 625.1286567308909, 630.1720818478102, 635.2219378550597, 
			640.2781836604080, 645.3407786934350, 650.4096828956552, 655.4848567108891, 
			660.5662610758735, 665.6538574111059, 670.7476076119127, 675.8474740397369, 
			680.9534195136375, 686.0654073019940, 691.1834011144108, 696.3073650938140, 
			701.4372638087371, 706.5730622457873, 711.7147258022900, 716.8622202791035, 
			722.0155118736012, 727.1745671728158, 732.3393531467393, 737.5098371417774, 
			742.6859868743513, 747.8677704246433, 753.0551562304841, 758.2481130813743, 
			763.4466101126401, 768.6506167997169, 773.8601029525584, 779.0750387101673, 
			784.2953945352457, 789.5211412089589, 794.7522498258135, 799.9886917886434, 
			805.2304388037030, 810.4774628758635, 815.7297363039102, 820.9872316759379, 
			826.2499218648428, 831.5177800239062, 836.7907795824699, 842.0688942417004, 
			847.3520979704384, 852.6403650011329, 857.9336698258574, 863.2319871924055, 
			868.5352921004645, 873.8435597978658, 879.1567657769075, 884.4748857707518, 
			889.7978957498902, 895.1257719186797, 900.4584907119451, 905.7960287916464, 
			911.1383630436112, 916.4854705743287, 921.8373287078048, 927.1939149824768, 
			932.5552071481862, 937.9211831632081, 943.2918211913357, 948.6670995990199, 
			954.0469969525604, 959.4314920153494, 964.8205637451659, 970.2141912915183, 
			975.6123539930361, 981.0150313749083, 986.4222031463685, 991.8338491982235, 
			997.2499496004279, 1002.670484599700, 1008.095434617182, 1013.524780246136, 
			1018.958502249690, 1024.396581558613, 1029.838999269135, 1035.285736640802, 
			1040.736775094367, 1046.192096209725, 1051.651681723869, 1057.115513528895, 
			1062.583573670030, 1068.055844343701, 1073.532307895633, 1079.012946818975, 
			1084.497743752466, 1089.986681478622, 1095.479742921963, 1100.976911147256, 
			1106.478169357801, 1111.983500893733, 1117.492889230361, 1123.006317976526, 
			1128.523770872991, 1134.045231790853, 1139.570684729985, 1145.100113817496, 
			1150.633503306224, 1156.170837573242, 1161.712101118401, 1167.257278562880};
	
	}

	PASTELMATH real lnFactorial(integer n)
	{
		PENSURE1(n >= 0 && n <= 256, n);
		
		return lnFactorial_[n];
	}
	
}
